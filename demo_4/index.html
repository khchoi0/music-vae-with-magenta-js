<html>
<head>
    <meta charset="UTF-8">
    <title>Melody Mixer</title>
    <meta name="description" content="Melody Mixer">
    <meta content="A fun way to explore melodies using machine learning." name="description">
    <meta content="Melody Mixer" property="og:title">
    <meta content="./data/images/melody-mixer-og2.jpeg" property="og:image">
    <meta content="A fun way to explore melodies using machine learning." property="og:description">
    <meta content="summary" name="twitter:card">
    <meta name="twitter:title" content="Melody Mixer" />
    <meta name="twitter:description" content="A fun way to explore melodies using machine learning." />
    <meta name="twitter:image" content="./data/images/melody-mixer-og2.jpeg" />

    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-86665855-4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-86665855-4', {
            'referrer' : document.referrer.split('?')[0],
        });
    </script>
    
    <script language="javascript" type="text/javascript" src="https://storage.googleapis.com/melody-mixer/musicvae.js"></script>
    <script language="javascript" type="text/javascript" src="./libraries/p5.js"></script>
    <script src='https://unpkg.com/tone@latest/build/Tone.js'></script>
    <script language="javascript" type="text/javascript" src="./preset-melodies.js"></script>
    <script language="javascript" type="text/javascript" src="https://storage.googleapis.com/melody-mixer/StartAudioContext.js"></script>
    <link href="/data/images/favicon-melody-mixer-small.png" rel="shortcut icon" type="image/x-icon">
    <link href="/data/images/favicon-melody-mixer.png" rel="apple-touch-icon">
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <section class="splash">
        <div class="splash-wrapper">
            <img class="splash-icon" src="./data/images/melody-mixer.gif" width="375" height="auto" alt="Melody Mixer icon"/>
            <h1>MELODY MIXER</h1>
            <div class="device-supported">
                <p class="splash-description">A fun way to explore music using machine learning. 
                    <br/>Just pull the blocks apart to see what melodies you discover.
                </p>
                <button class="splash-play-button" id="splash-play-button" onclick="onPlay();" disabled>LOADING...</button>
                <p class="splash-description">
                </p>
                <p class="built-with">
                    Built with TensorFlow.js + p5.js + MusicVAE.js + Tone.js.
                    <br/> Music VAE </a>
                    <br/> Group 5 </a>
                </p>

            </div>
            <p class="device-not-supported" style="display: none">Sorry, looks like your browser or device doesn't support this experiment.
                Learn more about Melody Mixer
                <a target="_blank" href="https://medium.com/@torinblankensmith/how-to-blend-melodies-with-machine-learning-in-real-time-in-the-browser-8ad5b42b4d0b">here</a>.
                Or try visiting this site on a desktop computer in a browser like Chrome.</p>
        </div>
    </section>

    <div class="control-container">
        <div class="drop-down-container">
          <select name="melody-one" class="drop-down">
              <option>Melody 1</option>
          </select>
          <label for="melody-one">Melody 1</label>
        </div>
        <button class="play-pause-button"></button>
        <div class="drop-down-container">
          <select name="melody-two" class="drop-down">
              <option>Melody 2</option>
          </select>
          <label for="melody-two">Melody 2</label>
        </div>
    </div>
    <script language="javascript" type="text/javascript" src="demo_4.js"></script>

    <h3>Current type: <span id="type"></span> <br> Current vol: <span id="vol"></span></h3>
    <ul id="piano">
        <li id="d" data-note="C4" class="key">
            <div id="r" data-note="C#4" class="black-key">R</div>
            D
        </li>
        <li id="f" data-note="D4" class="key">
            <div id="t" data-note="D#4" class="black-key">T</div>
            F
        </li>
        <li id="g" data-note="E4" class="key">
            G
        </li>
        <li id="h" data-note="F4" class="key">
            <div id="u" data-note="F#4" class="black-key">U</div>
            H
        </li>
        <li id="j" data-note="G4" class="key">
            <div id="i" data-note="G#4" class="black-key">I</div>
            J
        </li>
        <li id="k" data-note="A4" class="key">
            <div id="o" data-note="A#4" class="black-key">O</div>
            K
        </li>
        <li id="l" data-note="B4" class="key">
            L
        </li>
        <li id=";" data-note="C5" class="key">
            ;
        </li>
    </ul>

    <script>
        // Queue class
        const synth = new Tone.Synth();
        var queue = new Queue();

        var type = ["sine", "triangle", "square", "sawtooth"],
            partial = 0,
            enablePartial = false,
            vol = 50;

        function changeType(type, enablePartial = false, partial = "") {
            if (!enablePartial) partial = "";
            synth.oscillator.type = type + partial;
            document.getElementById('type').textContent = synth.oscillator.type.toUpperCase();
        }

        changeType(type[0], enablePartial, partial);
        synth.volume.value -= 20;
        document.getElementById('vol').textContent = vol;

        document.addEventListener('keydown', (e) => {
            var keyCode = e.which,
                arrow = { left: 37, up: 38, right: 39, down: 40, space: 32, };

            switch (e.keyCode) {
                case arrow.up:
                    if (vol < 100) {
                        synth.volume.value += 2;
                        vol += 5;
                    }
                    break;
                case arrow.down:
                    if (vol > 10) {
                        synth.volume.value -= 2;
                        vol -= 5;
                    }
                    break;
                case arrow.left:
                    type.unshift(type.pop());
                    break;
                case arrow.right:
                    type.push(type.shift());
                    break;
                default:
                    return;
            }
            changeType(type[0], enablePartial);
            document.getElementById('vol').textContent = vol;
        });

        synth.toDestination();

        // mouse play events
        var clickedKey;

        document.getElementById('piano').addEventListener('mousedown', (e) => {
            synth.triggerAttack(e.target.dataset.note);
            clickedKey = e.target.id;
            e.target.classList.add('active');
        });
        document.addEventListener('mouseup', (e) => {
            synth.triggerRelease();
            document.getElementById(clickedKey).classList.remove('active');
        });

        // keyboard play events
        var pressingKeys = [],
            keys = ["d", "f", "g", "h", "j", "k", "l", ";", "r", "t", "u", "i", "o",];

        document.addEventListener('keydown', (e) => {
            if (keys.includes(e.key)) {
                synth.triggerAttack(document.getElementById(e.key).dataset.note);
                if (queue.items.length != 32) {
                    queue.enqueue(document.getElementById(e.key).dataset.note);
                } else if (queue.items.length == 32) {
                    queuee.dequeue();
                    queue.enqueue(document.getElementById(e.key).dataset.note);
                }
                pressingKeys.push(e.key);
                document.getElementById(e.key).classList.add('active');
            }
        });
        document.addEventListener('keyup', (e) => {
            if (keys.includes(e.key)) {
                if (pressingKeys.includes(e.key)) synth.triggerRelease();
                pressingKeys = pressingKeys.filter(item => item !== e.key);
                document.getElementById(e.key).classList.remove('active');
            }
        });

        // lab requirement: use z x c v to tune the oscillations
        // here changes the oscillations' partial count
        // intentionally hidden from user
        document.addEventListener("keydown", e => {
            switch (e.key) {
                case "z":
                    changeType(type[0], true, 4);
                    return;
                case "x":
                    changeType(type[0], true, 8);
                    return;
                case "c":
                    changeType(type[0], true, 16);
                    return;
                case "v":
                    changeType(type[0], true, 32);
                    return;
            }
        });
    </script>
</body>
</html>